YUI.add("common-ui-conv-listview-ext",function(e){var t=e.Node,n=e.one,r=e.Lang,i=e.Array,s=e.common.Utils,o=s.features,u=s.settings,a=s.log,f=e.Object,l=e.common.ui.TimeChunk,c="#",h="list",p="requestSize",d="pageSize",v="page",m="dash",g="pageCount",y="loading",b=".",w="setrange",E="selected",S="remove",x="update",T="renderComplete",N="list-stat:scrolRenderComplete",C="KEY",k="SUBKEY",L="reverse",A="focused",O="tabIndex",M="height",_="prefetch",D="append",P=n("body"),H=n("#main"),B,j;e.mix(e.common.ui.ConvListView.prototype,{_selectRange:function(t,n,r,i){var s=this,o=s._getIndexN,u,a,f,l,c;t._node&&(t=o(t)),r._node&&(r=o(r)),f=l=r;if(e.Lang.isNumber(r)){u=s._isSubindex(f),a=s._isSubindex(t);if(u!=a)return;if(u){if(s._getMainindex(f)!=s._getMainindex(t))return;t=s._getSubindex(t),f=s._getSubindex(f)}c=t<=f?-1:1;while(f!==t+c)s._selectByIndex(l,n,0,1,0,1),u?l[1]+=c:l+=c,f+=c}i||s.set("selectionCount",s.selCount())},_updateItem:function(r,i,s){var o=this,u="list-view-item-date-label",a="this-week",f="data-tc-label",l=i?o.stop()-1:r,h=o._model.valueAt(l),p=n(c+o._id(r)),d=p?o._getItemContainer(p):null,v=o.get("activeItem"),m,g,y,w,E,S,x,T,N,C,k,L,M,_,D;if(h&&p){S=v?o._getIndexN(v):-1,w=o._lastSel?o._getIndexN(o._lastSel):-1,E=o._lastSS?o._getIndexN(o._lastSS):-1,m=o.get(A)&&v,g=r==o._getMainindex(w),y=r==o._getMainindex(E),o.fire("beforeItemUpdate"),x=o._selectToRender(),NeoConfig.timeChunk&&o.listObj.timeChunk&&(L=p&&p.get("parentNode"),M=L&&L.previous(),_=NeoConfig.rearrangeMb&&M&&M.previous(),_&&_.hasClass(u)?(h.addDateLabel="",_.hasClass(a)&&(h.thisWeek=a,h.label=_.getAttribute(f))):M&&M.hasClass(u)?(h.addDateLabel="",M.hasClass(a)&&(h.thisWeek=a,h.label=M.getAttribute(f))):h.addDateLabel=""),h.msgs&&h.msgs[0]&&(h.snippet=h.msgs[0].snippet),k=t.create(o._renderItem(h,l,x[l],o._id(l),s));if(i){if(m||g)T=p.next(b+o.ITEM_CLASS_NAME)||k;d.remove(),k&&o._srcNode.append(k)}else d&&d.replace(k);o.fire("itemUpdate",{itemIndex:l,itemNode:k}),e.fire("listview:itemUpdate",k,h),m&&v!=null&&o._getMainindex(S)==r&&(T=n(c+o._id(S)),T&&o._focusItem(T)),g&&(N=n(c+o._id(w)),N&&(o._lastSel=N)),y&&(C=n(c+o._id(E)),C&&(o._lastSS=C)),r==o.start()&&!v&&(D=k?k.one(".list-view-item"):null,D&&(D.set(O,0),o._focusItem(D,1)))}},_handleFailure:function(e){var t=this;e.start!==0&&e.reason!=="prefetch"&&t.set("page",t.get("page")-1,{noupdate:1}),t.set("freeze",0)},_listchange:function(e){var t=this,n,r,i=t._sel,o,u={},l,c,p,m,y,b=t.checkmode,E=e.subtype||"DEFAULT";a({m:"list model changed",reason:e.subtype});try{switch(e.subtype){case w:t._ss&&f.size(t._ss)&&(t._sel=t._model.indexesOf(t._ss)),t._sync(),t._lastSS=0,f.some(t._sel,function(e,n){return t._lastSel=t.getItemEl(n),1}),t._ss=0;break;case D:t._appendConversations(t.start(),t.stop());break;case _:break;case x:t._updateItem(e.index,!1,e.expand);break;case L:m=f.keys(i),c=m.length,o=t._model.get("length"),c===1?(p=m[0],y=p==o-p?p:o-p-1,t.set(v,Math.floor(y*1/t.get(d))),u[y]=i[m[0]]):t.set(v,0),t._clearSelect(1),t._sel=u,n=1,t.checkmode=b;break;case S:t._clearSelect(1),e.list&&e.list.length&&(r=t.getItemEl(e.list[0]))&&(t._set("activeItem",r),t._model.get(h).length===parseInt(e.list[0],10)?t._select(t.getItemEl(e.list[0]-1),1):t._select(r,1)),t.get("isActive")||t._set("activeItem",null),l=t.get(g),t.get(v)>=l&&t.set(v,l-1),n=1,t.setAttrs({focused:!0});break;default:n=1}n&&t._sync(!1,E)}catch(T){typeof globals!="undefined"&&globals.report?globals.report("caughterror:..-build-common-ui-listview-conv-listview-ext:1",T,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-common-ui-listview-conv-listview-ext:1"),s.error.report("ConvView-ListExt listchange error for subtype: "+e.subtype,T,1,1,1)}},_appendConversations:function(t,n){var r=this,i=r._model.get(h),s=0,u=o.enabled("prefetchConversations")?r.get(d):r.get(d)*2,a=[],f=r._sel,c=r._srcNode,p=[],v=r.listObj?r.listObj.sortedColumn.sortOrder:"",m,g;if(B!==t||j!==n)r.setUpScrollSuccessRateStats(),B=t,j=n;if(r._r){r.fire("beforeRender"),r.fire("appendConversations"),r.set("showFocus",!1);for(g=t;g<n;g++){m=i[g];if(!m){s=1;break}p.push(i[g]),NeoConfig.timeChunk&&r.listObj.timeChunk&&(m.addDateLabel=l.addDateLabel(g,m,g>0?i[g-1]:"",v)),a.push(r._renderItem(m,g,f[g],r._id(g),!1))}s?(r._insertLoadingIndicator(),r._model.request(t,u,D)):c.all("."+r.PAGE_CLASS_NAME).size()*r.get(d)<t+1&&(r._removeLoadingIndicator(),c.appendChild('<div role = "presentation" id="'+e.guid()+'"class = "'+r.PAGE_CLASS_NAME+'">'+a.join("")+"</div>"),NeoConfig.timeChunk&&v==="down"&&l.addThisWeekLabel(),r.set("freeze",0),r.fire(T,{silent:!0}),r.fire(N),o.enabled("prefetchConversations")&&r._prefetch())}},_insertLoadingIndicator:function(){var e=this,t=e._srcNode,n="listloading";t.one("#"+n)||t.appendChild("<div id="+n+' class="s-loader"></div>')},_removeLoadingIndicator:function(){var e=this,t=e._srcNode.one("#listloading");t&&t.remove().destroy(!0)},_renderVisiblePages:function(){var e=this,t=e._srcNode.get("scrollTop"),n=e.getCurrentPage(t),r,i=n-1<0?n:n-1;for(r=i;r<=n+1;r++)e.renderPage(r);a({m:"Rendered Mail list pages",currPage:n,range:i+"-"+n-1})},_sync:function(t,i){function f(){var r=this,u=r._model.get(h),f=0,c=r.stop(),v=t,m=r._srcNode,g=r._statusNode,y=r._maxLength,w=r._sel,S=r.get("activeItem"),x=r.get(d),N=e.Object.getValue(r,["listObj","fid"]),C=m.one("."+r.PAGE_CLASS_NAME),k=r.listObj?r.listObj.sortedColumn.sortOrder:"",L=r.get("page"),O=[],_=[],D=0,B,j,F,I,q,R,U,z,W,X,V;a({m:"Entering sync",syncReason:i}),C&&(F=parseInt(C.getComputedStyle("height"),10)),q=r.getCurrentPage();if(r._r){r.fire("beforeRender"),r.set("showFocus",!1);for(W=f;W<c;W++){X=u[W];if(!X){v=1,D=W;break}_.push(u[W]),W%x===0&&(I=W/x,W!==0&&O.push("</div>"),!F||I>=q-1&&I<=q+1||I===L?O.push('<div role = "presentation" class = "'+r.PAGE_CLASS_NAME+'">'):O.push('<div role = "presentation" class = "'+r.PAGE_CLASS_NAME+'" style="height:'+F+'px">'));if(I>=q-1&&I<=q+1||I===L)W%x===0,NeoConfig.timeChunk&&r.listObj.timeChunk&&(X.addDateLabel=l.
addDateLabel(W,X,W>0?u[W-1]:"",k)),O.push(r._renderItem(X,W,w[W],r._id(W),!1))}O.length&&O.push("</div>"),v?c-D<200?(j=t?r.get(d)*2:r.get(d),R=Math.max(c-D,j)||r.get(p),a({m:"Sync din't find all the mails, request for more",from:D,size:R}),r._model.request(D,R,i)):r.refresh(1):(g&&g.addClass("hidden"),o.enabled("predictiveSearch")?(U=e.Node.create(O.join("")||"<div></div>"),U&&r.smwNode&&(z=r.smwNode.one(".search-my-world"),N==="Inbox"&&z?(U.insert(r.smwNode,0),P.addClass("no-mb")):NeoConfig.moneyballEnabled&&P.removeClass("no-mb")),s.remove(m.get("children")),m.insert(U)):(s.remove(m.get("children")),m.setHTML(O.join(""))),NeoConfig.timeChunk&&k==="down"&&(n(".list-view-items").removeClass("etw").setAttribute("data-tc-label",""),l.addThisWeekLabel()),m.setStyle(M,"auto"),_.length&&(V=P&&P.hasClass("notoolbar")||H&&H.hasClass("withouttoolbar"),V||(e.fire("mbEvent:rotate"),e.fire("rotateD2S"))),r.set("freeze",0)),r._maxLength=Math.max(y,m.get("offsetHeight")),t?r.set("activeItem",null):(B=r._parentNode,S=B.one(b+r.ITEM_CLASS_NAME+b+E),S||(i==="remove"?(_=B.all(b+r.ITEM_CLASS_NAME),S=_.item(_.size()-1)):S=B.one(b+r.ITEM_CLASS_NAME)),S&&(r.set("activeItem",S),r.get(A)&&r._focusItem(S),r._lastSel=S));if(!v){if(this.selCount()){if(r._lastSel)W=r._getIndexN(r._lastSel);else for(W in w)break;r._lastSS=r._lastSel=r.getItemEl(W)}i!=="liststore"&&r._prefetch(i),e.fire("listview:sync",i),r.fire(T)}o.enabled("timeChunk")&&r.updateAnchoredLabel(!0,!1)}}a({m:"_sync called"});var u=this;u.tmSync&&u.tmSync.cancel(),u._tmSync=r.later(0,u,f)},_resetScrollTop:function(){var e=this._parentNode.one(b+this.LIST_CLASS_NAME);e.set("scrollTop",0)},_setStatus:function(t){var n=this,r,i=!1,s="";r=n._statusNode,t=t||"",i=t.hideLoader||!1,s=t.tmpl||t,!r&&n._parentNode&&(r=e.Node.create('<div role="'+n.STATUS_ROLE+'" tabindex="-1" class="status '+n.STATUS_CLASS_NAME+'"></div>'),r.addClass("hidden"),n._statusNode=r,n._parentNode.one("#lv-statuses-container").prepend(r),n._maxLength=Math.max(500,n._srcNode.get("offsetHeight"))),r&&(i?r.removeClass(y):r.addClass(y),s==="loading-icon"&&(s='<div class="s-loader"></div>'),n._status=s||"",s&&n.get("focused")&&r.focus(),r.setContent(n._status),r.removeClass("hidden"),n._srcNode.setContent(""),n._srcNode.setStyle(M,n._maxLength+"px"))},_prefetch:function(e){var t=this,n=t._model.get(h),r=t.stop(),i=Math.min(n.length,r+t.get(d))-1;e==="remove"&&(i-=u.value("LFTDeleteBufferSize",0)),r<n.length&&!n[i]&&(a({m:"prefetching conversations",start:r,reqSize:t.get(d)*2}),t._model.request(r,t.get(d)*2,_))},_setSelection:function(e){function u(){s=t._model.get(h),i.each(e,function(e){o[e]=s[e]||1,n=e}),t._sel=o}var t=this,n,s=t._model.get(h),o={};t._clearSelect(),e=e?r.isObject(e)?f.keys(e):r.isArray(e)?e:[e]:[],u(),n&&(s[n]||t.once(T,u,t),t.set("page",Math.floor(n/t.get(d)),{noupdate:1})),a({m:"sync for _setSelection"}),t._sync()},_blur:function(){return},_moveToItem:function(e,t){var n=this,r=!0,i={188:1,190:1},s;if(e){n._focusItem(e);if(!t.metaKey&&!t.ctrlKey||t.ctrlKey&&!t.keycodeOverride&&i[t.keyCode]){t.shiftKey&&n._lastSel?n._select(n._lastSel,0,e,1,0,!0):n._clearSelect(),n._lastSel=e,n._select(e,1,n._lastSS,t.shiftKey);if(n.selCount()==1||!t.shiftKey)n._lastSS=e;r=!1}t.subselect&&(s=this._getSubindex(n._getIndexN(e)))>=0&&(n._subselIndex=s,n.fire("subselect"),n._subselIndex=-1),n.set("showFocus",r)}t.halt&&t.halt()},_expandItem:function(e,t,n){var r,i,s=this,o=s._model;o.expanding||(o.expanding=!0,(r=s._getSubitemContainer(n))?(s._showSubitems(r,e),o.expanding=!1):o.getSubitem(e,0)?(o.update(t,e,!0),n=s.getItemEl(t),i=s._getItemContainer(n),i.removeClass("expanded"),o.expanding=!1,s._expandItem(e,t,n)):o.requestSub(e,t),s.set("activeItem",n),s.set("showFocus",null),s.fire("expand"))},_getNeighborItem:function(e,t){var n=this,r,i,s,o=n._getIndexN(e),u=b+n.ITEM_DETAIL_CLASS_NAME;if(n._isSubindex(o))i=e[t?"next":"previous"](u),i||(i=n._getMasterItem(e),t&&(i=n._getNeighborMasterItem(i,t)));else{if(t&&e.ancestor(".list-view-item-container").hasClass("expanded")&&(r=n._getSubitemContainer(e)))if(i=n._getEndDetailItem(r,!0,!1))return i;i=n._getNeighborMasterItem(e,t);if(i&&!t&&i.ancestor(".list-view-item-container").hasClass("expanded")&&(r=n._getSubitemContainer(i)))if(s=n._getEndDetailItem(r,!1,!1))return s}return i},_resetSelection:function(e){var t=this,n,r,i,s,o=null,u=f.keys(t._sel);if(u)for(n=0;n<u.length;n++){r=t._toIndexN(u[n]);if(t._getMainindex(r)==e){i=t._getSubindex(r);if(i==-1){o=r;break}if(o==null||t._getSubindex(r)<t._getSubindex(o))o=r}}if(o!=null){t._clearSelect();if(s=t.getItemEl(o))t._set("activeItem",s),t._select(s,1);t.get("isActive")||t._set("activeItem",null)}},_disableMouseHover:function(){var t=this,n=e.one("#msg-list");if(!n)return;t.keyboardActiveEvent||(n.addClass("keyboard-active"),t.keyboardActiveEvent=n.on("mousemove",t._enableMouseHover,t))},_enableMouseHover:function(t){var n=this,r=e.one("#msg-list");n.clientX&&n.clientY?t.clientX!==n.clientX&&t.clientY!==n.clientY&&(r&&r.removeClass("keyboard-active"),n.keyboardActiveEvent.detach(),n.keyboardActiveEvent=null,n.clientX=null,n.clientY=null):(n.clientX=t.clientX,n.clientY=t.clientY)},_keydown:function(e){var t=this,r=t.get("activeItem"),i,s,o=b+t.ITEM_CLASS_NAME,u,a=t._getListItem(e,1),f,l,h,p,d,v,m,g=a?a.hasClass(E):0,y=0,w;t._disableMouseHover(),w=r?t._getIndexN(t.get("activeItem")):t._lastSel?t._getIndexN(t._lastSel):y,r||(r=t.getItemEl(w));if(!r||!t._srcNode.contains(r)){var S=Math.floor(w/t.get("pageSize"));t.renderPage(S,t._srcNode.all("."+t.PAGE_CLASS_NAME).item(S)),r=t.getItemEl(w)}t._set("activeItem",r);switch(e.keyCode){case 37:case 39:if(t.selCount()==1&&!t.get("previewPaneEnabled")){p=t._getIndexN(r),d=t.getItemEl(p),v=t._getItemContainer(d);if(v.hasClass("expanded")&&e.keyCode===37||!v.hasClass("expanded")&&e.keyCode===39){l=t._isSubindex(p),h=t._model.valueAt(p),f=t._model.isCollapsible(h),l&&(p=t._getMainindex(p));if(f||l)d=n(c+t._id(p)),t._expandItem(h,p,d),e.halt()}}break;case 38:case 40
:case 188:case 190:e.altKey?(i=t.getItemEl(e.keyCode===38||e.keyCode===188?t.start():t.stop()-1),i&&(e.keyCode===40||e.keyCode===190)&&(s=t._getEndDetailItem(i,!1,!1))&&(i=s)):r&&(i=t.selCount()?t._getNeighborItem(r,e.keyCode===40||e.keyCode===190):r,i&&t._isSubindex(t._getIndexN(i))&&(m=e.ctrlKey,e.shiftKey=!1,e.ctrlKey=e.metaKey=!0,e.subselect=!m,!m&&t.selCount()==1&&t.get("selection")[0]!=t._getMainindex(t._getIndexN(i))&&(t._clearSelect(),t._select(t._getMasterItem(i),1))),!e.shiftKey&&!e.metaKey&&!e.ctrlKey&&t._lastSel&&t._lastSel.get("id")!==r.get("id")&&!t._isSubindex(t._getIndexN(r))&&(i=r)),i&&(!e.shiftKey&&!e.metaKey&&!e.ctrlKey&&t.selCount()&&t._clearSelect(),i=t.getItemEl(t._getIndexN(i)),t._moveToItem(i,e)),e.halt();break;case 32:if(e.metaKey||e.ctrlKey||e.altKey)return;a||(a=t.getItemEl(w),g=a?a.hasClass(E):0);if(t._isSubindex(t._getIndexN(a)))return;if(!t._checkbox(e)){if(t._isFormControl(e))return;e.shiftKey?t._selectRange(t._lastSS,!t._sel[t._getIndexN(r)],a):(g&&!t.checkmode?u=1:u=!g,t._select(a,u,0,1),t._lastSel=t._lastSS=u?a:0),e.halt()}break;case 13:t.selCount()==1&&(p=t._getIndexN(r),h=t._model.valueAt(p),l=t._isSubindex(p),f=t._model.isCollapsible(h),l||!f||!t.get("expandOnClick")?(t.fire("command",{e:e,index:l?t._getSubindex(p):t._getMainindex(p),subindex:l?t._getSubindex(p):-1,mainindex:t._getMainindex(p),item:h}),t.get("previewPaneEnabled")||e.halt()):(d=n(c+t._id(p)),t._expandItem(h,p,d),e.halt()));break;case 36:t.scrollToTop(),e.halt();break;case 33:if(e.ctrlKey)break;t.pageUpOrDown(!0),e.halt();break;case 34:if(e.ctrlKey)break;t.pageUpOrDown(!1),e.halt()}},_isCheckboxBorder:function(e){var t=e.target,n,r=0,i=0,s,o;if(t.hasClass("list-view-item"))return NeoConfig.hoverPreview||(o=t.one("div.info"),o&&(r=o.get("offsetWidth"))),s=t.one("input"),s&&(i=s.get("offsetWidth")),n=t.getX()||0,e.clientX>n&&e.clientX<n+i+r},getPageIndex:function(e){var t=this,n=t.get("page"),r=t.get("pageSize"),i=t._getListItem(e,1),s=t._getIndexN(i),o=s-n*r;return o},setUpScrollSuccessRateStats:function(){var t=this;t.scrolRenderCompleteHandler&&t.scrolRenderCompleteHandler.detach(),e.fire("stat:feature_invoke",{message:"UI_LIST_CONV_SCROLL_START_SUCCESS",feature_group:"LIST"}),t.scrolRenderCompleteHandler=t.once(N,function(){e.fire("stat:feature_complete",{message:"UI_LIST_CONV_SCROLL_COMPLETE_SUCCESS",feature_group:"LIST"})})}},1),e.mix(e.common.ui.ConvListModel.prototype,{setRange:function(e,t,n){var r=this,i=t.length,s=t||[],o=r.get(h),u=o.length;n=n||w,r._refresh&&(o=[],o.length=u,r._refresh=0);while(i--)o[e+i]=s[i];r.set(h,o,{subtype:n,start:e})},update:function(e,t,n){var r=this.get(h);try{r[e]=t,this.set(h,r,{subtype:x,index:e,expand:n})}catch(i){typeof globals!="undefined"&&globals.report?globals.report("caughterror:..-build-common-ui-listview-conv-listview-ext:2",i,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-common-ui-listview-conv-listview-ext:2"),s.error.report("ConvView-ListExt update error",i,1,1,1)}},remove:function(t){var n=this,s=r.isArray(t)?i(t).sort(i.numericSort):f.keys(t),o=s.length,u=n.get(h);s=i(s).sort(i.numericSort),e.fire(n.NAME+":remove",u,s);while(o--)u.splice(s[o],1);n.set(h,u,{subtype:S,list:s})},reverse:function(){var e=this,t=e.get(h);t.reverse(),e.set(h,t,{subtype:L})},indexesOf:function(e,t,n){var s,o,u=this,a,f,l,c,p=u.get(t?k:C),d=u.get(h),v={},g={},y=d.length;e=r.isArray(e)?e:[e],i.each(e,function(e){v[e[p]]=e});for(s=0;s<y;s++){a=d[s];if(t){l=u.getSubitemCount(a);for(o=0;o<l;o++)f=u.getSubitem(a,o),f&&v[f[p]]&&(c=s+m+o,g[s+m+o]=f)}else if(a=d[s]&&v[a[p]])g[s]=a}return n&&n(g),g}},1)},"1.0.0",{requires:["common-ui-conv-listview","common-ui-notification","mail-common-utils-features","mail-common-utils-settings","common-utils"]});
