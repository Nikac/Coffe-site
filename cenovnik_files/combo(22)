YUI.add("mail-ui-desktop-notifications-mail",function(e){function v(t){return!e.Lang.isArray(t)||t.length===0?!1:!0}function m(e){return typeof t.getVal(e,"from.name")=="undefined"||typeof t.getVal(e,"from.email")=="undefined"?!1:!0}function g(e){var t=!0,n,r;if(!v(e))return null;if(e[0].cid===undefined)return null;if(e.length===1)return!0;r=e[0].cid;for(n=1;n<e.length;n++){if(!e[n].cid)return null;if(e[n].cid!==r){t=!1;break}}return t}function y(e){var t=[],n={},r=0,s=0,o,u,a;if(!v(e))return null;o=e.length;for(u=0;u<o;u++){if(!m(e[u]))return null;a=e[u].from.name.trim()!==""?e[u].from.name:e[u].from.email;if(a.trim()==="")continue;if(i-(16+t.length*2+s+a.length+2)<0)continue;a in n?(n[a]++,r++):(n[a]=1,t.push(a),s+=a.length)}return b(e,t,r)}function b(e,n,r){var i,s,o;return n.length===0?"":n.length!==1||n.length!==e.length&&r+1!==e.length?n.length+r<e.length?(s=e.length-(n.length+r),s===1?(i=strings.str_notif_other,t.ezSub(i,{comma_separated_recipient_list:n.join(", ")})):(i=strings.str_notif_others,t.ezSub(i,{comma_separated_recipient_list:n.join(", "),num_others:String(s)}))):(i=strings.str_notif_recipients,o=n.pop(),t.ezSub(i,{comma_separated_recipient_list:n.join(", "),single_recipient:o})):(i=strings.str_notif_recipient,t.ezSub(i,{single_recipient:n[0]}))}function w(t){e.fire("openMessage",{fid:t[0].folderInfo.fid||n.getInboxFid(),isConv:0,msg:t[0]}),window.focus()}function E(){e.fire("openInbox"),window.focus()}function S(t){e.fire("openConv",{fid:t[0].fid||n.getInboxFid(),isConv:1,isThread:!0,msg:t[0]}),window.focus()}function x(t,n){e.fire("util:ymstats",{name:"notifications_click_invoke",tags:{bucket:NeoConfig.expBucketId,isWinApp:NeoConfig.isWinApp,agent:NeoConfig.browser}}),NeoConfig.hasConvView?t.length>1&&!g(n)?E():S(t):t.length>1?E():w(t)}function T(e){var n;return v(e)?e.length>1?(n=strings.str_notif_new_msg,t.ezSub(n,{num_new_msgs:String(e.length)})):m(e[0])?e[0].from.name.trim()!==""?e[0].from.name:e[0].from.email:null:null}function N(t){return v(t)?t.length>1?y(t):e.common.Utils.getVal(t[0],"subject")?t[0].subject:"":null}function C(){var n=s,i,u,a=o,f,l;NeoConfig.hasConvView?i=n.reduce(function(e,t){return e.concat(t.msgs)},[]):i=n;if(!n||n.length===0)return;h=T(i),p=N(i);if(h===null||p===null)return;u=function(){s=[],x(n,i)},NeoConfig.isWinApp?i.length!==1?r=new window.Notification(h,{body:p}):(f=i[0],r=new window.Notification(h,{body:p,email:f&&f.from.email,tag:f&&f.mid,receivedDate:f&&f.receivedDate})):(t.features.enabled("mosaicNotifications")?l=k(i):l=i.length===1?L(i[0].from.email):undefined,r=c.notify(h,p,u,a,l)),e.fire("util:ymstats",{name:"notifications_notify_invoke",tags:{bucket:NeoConfig.expBucketId,agent:NeoConfig.browser,isWinApp:NeoConfig.isWinApp,length:i.length}})}function k(n){var r,i,s,o;return r=n.map(function(e){return e.from.email}).filter(function(e,t,n){return n.indexOf(e)===t}),i=e.xobniContacts.Utils.getXobniBaseURL().url+"/v4/contacts/endpoints/mosaic?emails="+r.slice(0,4).join(","),i+="&total="+r.length+"&badge=true&spsize=",o=t.settings.value("notificationToastImageRes"),typeof window.devicePixelRatio!="undefined"&&window.devicePixelRatio>=2&&(o*=2),i+=o+"x"+o,s=t.settings.value("yahooMailNotificationLogo")+o+"x"+o+"_2.png",i+="&fallback_url="+s,i}function L(n){var r,i,s;return r=e.xobniContacts.Utils.getXobniBaseURL().url+"/v4/endpoints/smtp:"+n+"/photo?format=image&badge=true&spsize=",s=t.settings.value("notificationToastImageRes"),typeof window.devicePixelRatio!="undefined"&&window.devicePixelRatio>=2&&(s*=2),r+=s+"x"+s,i=t.settings.value("yahooMailNotificationLogo")+s+"x"+s+"_2.png",r+="&fallback_url="+i,r}function A(t){this.watermark=t.getMostRecentTimestamp(),t.on("MailList:modelRefresh",this.onListRefresh,this),NeoConfig.multipleAccounts&&e.on("accounts:select",function(){d&&d.detach(),d=t.once("renderComplete",function(){this.watermark=t.getMostRecentTimestamp()},this)},this)}function O(t){var n;if(!_())e.use("mail-ui-onboarding-desktop-notification",function(){n=e.mail.ui.onboarding.mailDesktopNotificationOnboard,n.init(n.calloutType.AUTO_CHECK_MAIL),a=!1});else if(!NeoConfig.isWinApp&&window.Notification.permission!=="granted"&&c.getSavedPreference()==="granted")c.getUserPermission(function(t){e.fire("util:ymstats",{name:"notifications_permission_"+t,tags:{agent:NeoConfig.browser,bucket:NeoConfig.expBucketId}})});else{if(!v(t))return;f||(s.unshift.apply(s,t),e.mail.ui.mailDesktopNotifications.notify())}}function M(e){if(!e||typeof e.list=="undefined")return;var t=e.list.getNewMsgs(this.watermark),r=e.list.getMostRecentTimestamp();r&&n.isInboxFid(e.list.fid)&&(this.watermark=r),this.handleNotify(t)}function _(){return NeoConfig.isWinApp||!a||c.getSavedPreference()==="granted"}function D(){l.on("blur",function(){f=!1}),l.on("focus",function(){f=!0,r&&!NeoConfig.isWinApp&&r.close(),s=[]}),c.currentBrowserNeedsPermission()&&(c.getUserPermission(),e.fire("util:ymstats",{name:"notifications_login_new_browser",tags:{agent:NeoConfig.browser,bucket:NeoConfig.expBucketId}})),e.namespace("mail.ui").mailDesktopNotifications={isFromSameConv:g,init:A,onListRefresh:M,handleNotify:O,getRecepientList:y,openView:x,getTitle:T,getBody:N,getMosaicUrl:k,notify:C},a=!e.mail.persist.MetaData.get(u)}var t=e.common.Utils,n=e.mail.ui.FolderUtils,r=null,i=90,s=[],o="notification.mail",u="neo.pref.mailDesktopNotification.onboard",a=!1,f=!0,l=e.one("window"),c=e.mail.ui.desktopNotifications,h,p,d;NeoConfig.browser.toLowerCase().indexOf("safari")!==-1&&(i=45),(c.browserSupportNotification()||NeoConfig.isWinApp)&&D()},"1.0.0",{requires:["mail-ui-desktop-notifications","cookie","common-utils","xobni-utilities","mail-ui-folder-utils","ymma-stats","mail-persist-meta-data"]});
